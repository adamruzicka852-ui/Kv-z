<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proximity Voice Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; padding: 0; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script>
        const { useState, useEffect, useRef } = React;
        const e = React.createElement;

        // Simple localStorage-based sync (works across tabs on same computer)
        // For true multiplayer, you'd need a backend server
        const storage = {
            set: (key, value) => {
                localStorage.setItem(key, JSON.stringify({ value, timestamp: Date.now() }));
                window.dispatchEvent(new Event('storage-update'));
            },
            get: (key) => {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : null;
            },
            delete: (key) => {
                localStorage.removeItem(key);
                window.dispatchEvent(new Event('storage-update'));
            },
            list: (prefix) => {
                const keys = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith(prefix)) keys.push(key);
                }
                return keys;
            }
        };

        const ProximityVoiceChat = () => {
            const [username, setUsername] = useState('');
            const [joined, setJoined] = useState(false);
            const [position, setPosition] = useState({ x: 400, y: 300 });
            const [users, setUsers] = useState({});
            const [team, setTeam] = useState('none');
            const [muted, setMuted] = useState(false);
            const [deafened, setDeafened] = useState(false);
            const [mode, setMode] = useState('proximity');
            const [myId, setMyId] = useState(null);
            const [copied, setCopied] = useState(false);
            const canvasRef = useRef(null);
            const isDragging = useRef(false);

            const TEAMS = ['none', 'red', 'blue', 'green', 'yellow'];
            const TEAM_COLORS = {
                none: '#64748b',
                red: '#ef4444',
                blue: '#3b82f6',
                green: '#22c55e',
                yellow: '#eab308'
            };

            useEffect(() => {
                if (joined && !myId) {
                    const id = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    setMyId(id);
                }
            }, [joined, myId]);

            useEffect(() => {
                if (!myId || !joined) return;

                const updateMyPosition = () => {
                    storage.set(`user:${myId}`, {
                        name: username,
                        x: position.x,
                        y: position.y,
                        team: team,
                        muted: muted,
                        mode: mode,
                        lastUpdate: Date.now()
                    });
                };

                updateMyPosition();
                const interval = setInterval(updateMyPosition, 1000);

                return () => clearInterval(interval);
            }, [myId, username, position, team, muted, mode, joined]);

            useEffect(() => {
                if (!joined) return;

                const loadUsers = () => {
                    const userKeys = storage.list('user:');
                    const loadedUsers = {};
                    const now = Date.now();

                    userKeys.forEach(key => {
                        const data = storage.get(key);
                        if (data && data.value) {
                            const user = data.value;
                            const userId = key.replace('user:', '');

                            if (now - user.lastUpdate > 10000) {
                                storage.delete(key);
                            } else if (userId !== myId) {
                                loadedUsers[userId] = { id: userId, ...user };
                            }
                        }
                    });

                    setUsers(loadedUsers);
                };

                loadUsers();
                const interval = setInterval(loadUsers, 2000);
                window.addEventListener('storage-update', loadUsers);

                return () => {
                    clearInterval(interval);
                    window.removeEventListener('storage-update', loadUsers);
                };
            }, [joined, myId]);

            useEffect(() => {
                return () => {
                    if (myId) storage.delete(`user:${myId}`);
                };
            }, [myId]);

            useEffect(() => {
                if (!joined || !canvasRef.current) return;

                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                
                ctx.fillStyle = '#0f172a';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                ctx.strokeStyle = '#1e293b';
                ctx.lineWidth = 1;
                for (let i = 0; i < canvas.width; i += 50) {
                    ctx.beginPath();
                    ctx.moveTo(i, 0);
                    ctx.lineTo(i, canvas.height);
                    ctx.stroke();
                }
                for (let i = 0; i < canvas.height; i += 50) {
                    ctx.beginPath();
                    ctx.moveTo(0, i);
                    ctx.lineTo(canvas.width, i);
                    ctx.stroke();
                }

                if (mode === 'proximity') {
                    const gradient = ctx.createRadialGradient(position.x, position.y, 0, position.x, position.y, 200);
                    gradient.addColorStop(0, 'rgba(59, 130, 246, 0.2)');
                    gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                }

                Object.values(users).forEach(user => {
                    const distance = Math.sqrt(Math.pow(user.x - position.x, 2) + Math.pow(user.y - position.y, 2));
                    const canHear = mode === 'team' ? user.team === team && team !== 'none' : distance < 300;
                    
                    if (canHear && !deafened) {
                        ctx.strokeStyle = TEAM_COLORS[user.team] + '40';
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.moveTo(position.x, position.y);
                        ctx.lineTo(user.x, user.y);
                        ctx.stroke();
                    }

                    ctx.fillStyle = TEAM_COLORS[user.team];
                    ctx.beginPath();
                    ctx.arc(user.x, user.y, 20, 0, Math.PI * 2);
                    ctx.fill();

                    if (user.muted) {
                        ctx.fillStyle = '#ef4444';
                        ctx.beginPath();
                        ctx.arc(user.x + 15, user.y - 15, 6, 0, Math.PI * 2);
                        ctx.fill();
                    }

                    ctx.fillStyle = '#fff';
                    ctx.font = '12px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(user.name, user.x, user.y + 35);

                    if (mode === 'proximity') {
                        const volume = Math.max(0, Math.min(100, 100 - (distance / 300) * 100));
                        ctx.fillStyle = '#94a3b8';
                        ctx.font = '10px sans-serif';
                        ctx.fillText(`${Math.round(volume)}%`, user.x, user.y + 47);
                    }
                });

                ctx.fillStyle = TEAM_COLORS[team];
                ctx.beginPath();
                ctx.arc(position.x, position.y, 25, 0, Math.PI * 2);
                ctx.fill();

                if (muted || deafened) {
                    ctx.fillStyle = '#ef4444';
                    ctx.beginPath();
                    ctx.arc(position.x + 18, position.y - 18, 8, 0, Math.PI * 2);
                    ctx.fill();
                }

                ctx.fillStyle = '#fff';
                ctx.font = 'bold 14px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(`${username} (You)`, position.x, position.y + 45);
            }, [joined, position, users, team, mode, muted, deafened, username]);

            const handleMouseDown = (e) => {
                const rect = canvasRef.current.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                const distance = Math.sqrt(Math.pow(x - position.x, 2) + Math.pow(y - position.y, 2));
                if (distance < 25) {
                    isDragging.current = true;
                }
            };

            const handleMouseMove = (e) => {
                if (!isDragging.current) return;
                
                const rect = canvasRef.current.getBoundingClientRect();
                const x = Math.max(25, Math.min(rect.width - 25, e.clientX - rect.left));
                const y = Math.max(25, Math.min(rect.height - 25, e.clientY - rect.top));
                
                setPosition({ x, y });
            };

            const handleMouseUp = () => {
                isDragging.current = false;
            };

            const copyInviteLink = () => {
                navigator.clipboard.writeText(window.location.href);
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            };

            if (!joined) {
                return e('div', { className: 'min-h-screen bg-slate-900 flex items-center justify-center p-4' },
                    e('div', { className: 'bg-slate-800 rounded-lg shadow-xl p-8 max-w-md w-full' },
                        e('div', { className: 'flex items-center justify-center mb-6' },
                            e('div', { className: 'w-12 h-12 text-blue-500 text-4xl' }, 'üìª')
                        ),
                        e('h1', { className: 'text-3xl font-bold text-white text-center mb-2' }, 'Proximity Voice Chat'),
                        e('p', { className: 'text-slate-400 text-center mb-6' }, 'Share this page with friends to join!'),
                        e('div', { className: 'space-y-4' },
                            e('div', null,
                                e('label', { className: 'block text-sm font-medium text-slate-300 mb-2' }, 'Username'),
                                e('input', {
                                    type: 'text',
                                    value: username,
                                    onChange: (ev) => setUsername(ev.target.value),
                                    placeholder: 'Enter your name',
                                    className: 'w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500'
                                })
                            ),
                            e('div', null,
                                e('label', { className: 'block text-sm font-medium text-slate-300 mb-2' }, 'Team (optional)'),
                                e('select', {
                                    value: team,
                                    onChange: (ev) => setTeam(ev.target.value),
                                    className: 'w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500'
                                }, TEAMS.map(t => e('option', { key: t, value: t }, t.charAt(0).toUpperCase() + t.slice(1) + ' Team')))
                            ),
                            e('button', {
                                onClick: () => username.trim() && setJoined(true),
                                disabled: !username.trim(),
                                className: 'w-full py-3 bg-blue-600 hover:bg-blue-700 disabled:bg-slate-700 disabled:cursor-not-allowed text-white font-semibold rounded-lg transition-colors'
                            }, 'Join Space'),
                            e('div', { className: 'bg-blue-900/30 border border-blue-700 rounded-lg p-3 text-sm text-blue-200' },
                                e('p', { className: 'font-semibold mb-1' }, 'üí° Note: Multiple tabs on same computer'),
                                e('p', null, 'Open this file in multiple browser tabs to test! For true internet multiplayer, you need to host it online.')
                            )
                        )
                    )
                );
            }

            return e('div', { className: 'min-h-screen bg-slate-900 p-4' },
                e('div', { className: 'max-w-6xl mx-auto' },
                    e('div', { className: 'bg-slate-800 rounded-lg shadow-xl p-4 mb-4' },
                        e('div', { className: 'flex items-center justify-between flex-wrap gap-4' },
                            e('div', { className: 'flex items-center gap-4' },
                                e('h2', { className: 'text-xl font-bold text-white' }, username),
                                e('div', { className: 'flex items-center gap-2' },
                                    e('div', { className: 'w-4 h-4 rounded-full', style: { backgroundColor: TEAM_COLORS[team] } }),
                                    e('span', { className: 'text-slate-300 text-sm' }, team.charAt(0).toUpperCase() + team.slice(1) + ' Team')
                                )
                            ),
                            e('div', { className: 'flex items-center gap-2' },
                                e('button', {
                                    onClick: copyInviteLink,
                                    className: 'px-3 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-white text-sm font-medium transition-colors'
                                }, copied ? '‚úì Copied!' : 'üìã Copy Link'),
                                e('div', { className: 'bg-slate-700 rounded-lg p-1 flex gap-1' },
                                    e('button', {
                                        onClick: () => setMode('proximity'),
                                        className: `px-3 py-1 rounded text-sm font-medium transition-colors ${mode === 'proximity' ? 'bg-blue-600 text-white' : 'text-slate-300 hover:text-white'}`
                                    }, 'Proximity'),
                                    e('button', {
                                        onClick: () => setMode('team'),
                                        className: `px-3 py-1 rounded text-sm font-medium transition-colors ${mode === 'team' ? 'bg-blue-600 text-white' : 'text-slate-300 hover:text-white'}`
                                    }, 'Team Only')
                                ),
                                e('button', {
                                    onClick: () => setMuted(!muted),
                                    className: `p-3 rounded-lg transition-colors ${muted ? 'bg-red-600 hover:bg-red-700' : 'bg-slate-700 hover:bg-slate-600'}`
                                }, muted ? 'üîá' : 'üé§'),
                                e('button', {
                                    onClick: () => setDeafened(!deafened),
                                    className: `p-3 rounded-lg transition-colors ${deafened ? 'bg-red-600 hover:bg-red-700' : 'bg-slate-700 hover:bg-slate-600'}`
                                }, deafened ? 'üîá' : 'üîä')
                            )
                        )
                    ),
                    e('div', { className: 'bg-slate-800 rounded-lg shadow-xl p-4' },
                        e('div', { className: 'mb-4 flex items-center justify-between' },
                            e('div', { className: 'text-slate-300 text-sm' },
                                mode === 'proximity' ? 'üéØ Drag yourself around to hear people nearby' : `üë• Hearing only ${team} team members`
                            ),
                            e('div', { className: 'flex items-center gap-2 text-slate-400 text-sm' },
                                e('span', null, `üë• ${Object.keys(users).length + 1} in space`)
                            )
                        ),
                        e('canvas', {
                            ref: canvasRef,
                            width: 800,
                            height: 600,
                            onMouseDown: handleMouseDown,
                            onMouseMove: handleMouseMove,
                            onMouseUp: handleMouseUp,
                            onMouseLeave: handleMouseUp,
                            className: 'w-full border border-slate-700 rounded-lg cursor-move'
                        }),
                        e('div', { className: 'mt-4 grid grid-cols-2 gap-4 text-sm' },
                            e('div', { className: 'bg-slate-700 rounded-lg p-3' },
                                e('h3', { className: 'font-semibold text-white mb-2' }, 'Controls'),
                                e('ul', { className: 'text-slate-300 space-y-1' },
                                    e('li', null, '‚Ä¢ Drag your avatar to move'),
                                    e('li', null, '‚Ä¢ Click mic to mute yourself'),
                                    e('li', null, '‚Ä¢ Click speaker to deafen'),
                                    e('li', null, '‚Ä¢ Switch between modes')
                                )
                            ),
                            e('div', { className: 'bg-slate-700 rounded-lg p-3' },
                                e('h3', { className: 'font-semibold text-white mb-2' }, 'Status'),
                                e('ul', { className: 'text-slate-300 space-y-1' },
                                    e('li', null, '‚Ä¢ Mic: ' + (muted ? 'üî¥ Muted' : 'üü¢ Active')),
                                    e('li', null, '‚Ä¢ Audio: ' + (deafened ? 'üî¥ Deafened' : 'üü¢ Hearing')),
                                    e('li', null, '‚Ä¢ Mode: ' + (mode === 'proximity' ? 'üìç Proximity' : 'üë• Team')),
                                    e('li', null, `‚Ä¢ Online: ${Object.keys(users).length} other${Object.keys(users).length !== 1 ? 's' : ''}`)
                                )
                            )
                        )
                    )
                )
            );
        };

        ReactDOM.render(e(ProximityVoiceChat), document.getElementById('root'));
    </script>
</body>
</html>